{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Tracker = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar logging_1 = require(\"./logging\");\n\nvar error_1 = require(\"./error\");\n\nvar trackingEvents_1 = require(\"./trackingEvents\");\n\nvar trackedEvents = {};\n\nvar Tracker =\n/** @class */\nfunction () {\n  function Tracker(_a) {\n    var _b;\n\n    var tab = _a.tab,\n        tokenProvider = _a.tokenProvider,\n        channel = _a.channel,\n        logger = _a.logger,\n        inactivityRetryPolicy = _a.inactivityRetryPolicy,\n        options = tslib_1.__rest(_a, [\"tab\", \"tokenProvider\", \"channel\", \"logger\", \"inactivityRetryPolicy\"]);\n\n    this.listeners = [];\n    this.pending = [];\n    this.state = {\n      enabled: false,\n      initialized: false,\n      suspended: false\n    };\n    this.inactivityTimer = {\n      since: 0\n    };\n    this.tab = tab;\n    this.tokenProvider = tokenProvider;\n    this.inactivityRetryPolicy = inactivityRetryPolicy;\n    this.channel = channel;\n    this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n    this.options = tslib_1.__assign(tslib_1.__assign({}, options), {\n      eventMetadata: (_b = options.eventMetadata) !== null && _b !== void 0 ? _b : {}\n    });\n    this.enable = this.enable.bind(this);\n    this.disable = this.disable.bind(this);\n    this.suspend = this.suspend.bind(this);\n    this.unsuspend = this.unsuspend.bind(this);\n    this.trackPageLoad = this.trackPageLoad.bind(this);\n    this.trackTabVisibilityChange = this.trackTabVisibilityChange.bind(this);\n    this.trackTabUrlChange = this.trackTabUrlChange.bind(this);\n    this.trackInactivity = this.trackInactivity.bind(this);\n  }\n\n  Tracker.prototype.addListener = function (listener) {\n    this.listeners.push(listener);\n  };\n\n  Tracker.prototype.removeListener = function (listener) {\n    var index = this.listeners.indexOf(listener);\n\n    while (index >= 0) {\n      this.listeners.splice(index, 1);\n      index = this.listeners.indexOf(listener);\n    }\n  };\n\n  Object.defineProperty(Tracker.prototype, \"flushed\", {\n    get: function () {\n      var suppress = function () {// suppress errors\n      };\n\n      return Promise.all(this.pending).then(suppress, suppress);\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Tracker.prototype.isEnabled = function () {\n    return this.state.enabled;\n  };\n\n  Tracker.prototype.isSuspended = function () {\n    return this.state.suspended;\n  };\n\n  Tracker.prototype.enable = function () {\n    if (this.state.enabled) {\n      return;\n    }\n\n    this.logger.info('Tracker enabled');\n    this.state.enabled = true;\n\n    if (this.state.suspended) {\n      return;\n    }\n\n    this.startInactivityTimer();\n\n    if (!this.state.initialized) {\n      this.state.initialized = true;\n      this.initialize();\n    }\n\n    this.tab.addListener('load', this.trackPageLoad);\n    this.tab.addListener('urlChange', this.trackTabUrlChange);\n    this.tab.addListener('visibilityChange', this.trackTabVisibilityChange);\n  };\n\n  Tracker.prototype.disable = function () {\n    if (!this.state.enabled) {\n      return;\n    }\n\n    this.logger.info('Tracker disabled');\n    this.state.enabled = false;\n\n    if (this.state.suspended) {\n      return;\n    }\n\n    this.tab.removeListener('load', this.trackPageLoad);\n    this.tab.removeListener('urlChange', this.trackTabUrlChange);\n    this.tab.removeListener('visibilityChange', this.trackTabVisibilityChange);\n    this.stopInactivityTimer();\n  };\n\n  Tracker.prototype.suspend = function () {\n    if (this.state.suspended) {\n      return;\n    }\n\n    this.logger.info('Tracker suspended');\n\n    if (this.state.enabled) {\n      this.disable();\n      this.state.enabled = true;\n    }\n\n    this.state.suspended = true;\n  };\n\n  Tracker.prototype.unsuspend = function () {\n    if (!this.state.suspended) {\n      return;\n    }\n\n    this.logger.info('Tracker unsuspended');\n    this.state.suspended = false;\n\n    if (this.state.enabled) {\n      this.state.enabled = false;\n      this.enable();\n    }\n  };\n\n  Tracker.prototype.initialize = function () {\n    if (trackedEvents[this.tab.id] === undefined) {\n      trackedEvents[this.tab.id] = {};\n    }\n\n    var initEvents = trackedEvents[this.tab.id];\n\n    if (this.tab.isNew && !initEvents.tabOpened) {\n      initEvents.tabOpened = true;\n      this.trackTabOpen({\n        tabId: this.tab.id\n      });\n    }\n\n    if (!initEvents.pageOpened) {\n      initEvents.pageOpened = true;\n      this.trackPageOpen({\n        url: this.tab.url,\n        referrer: this.tab.referrer\n      });\n    }\n  };\n\n  Tracker.prototype.stopInactivityTimer = function () {\n    if (this.inactivityTimer.id !== undefined) {\n      window.clearTimeout(this.inactivityTimer.id);\n      delete this.inactivityTimer.id;\n    }\n  };\n\n  Tracker.prototype.startInactivityTimer = function () {\n    var _this = this;\n\n    this.stopInactivityTimer();\n    this.inactivityTimer.since = Date.now();\n    var iteration = -1;\n\n    var startTimer = function () {\n      if (!_this.inactivityRetryPolicy.shouldRetry(iteration + 1, _this.inactivityTimer.since)) {\n        window.clearTimeout(_this.inactivityTimer.id);\n        return;\n      }\n\n      iteration += 1;\n      _this.inactivityTimer.id = window.setTimeout(function () {\n        _this.trackInactivity();\n\n        startTimer();\n      }, _this.inactivityRetryPolicy.getDelay(iteration));\n    };\n\n    startTimer();\n  };\n\n  Tracker.prototype.track = function (event, timestamp) {\n    if (timestamp === void 0) {\n      timestamp = Date.now();\n    }\n\n    return this.publish(this.enrichEvent(event, timestamp), timestamp).then(function () {\n      return event;\n    });\n  };\n\n  Tracker.prototype.trackPageOpen = function (_a) {\n    var referrer = _a.referrer,\n        payload = tslib_1.__rest(_a, [\"referrer\"]);\n\n    this.enqueue(tslib_1.__assign(tslib_1.__assign({\n      type: 'pageOpened'\n    }, payload), referrer.length > 0 ? {\n      referrer: referrer\n    } : {}));\n  };\n\n  Tracker.prototype.trackPageLoad = function (_a) {\n    var tab = _a.detail.tab;\n    this.enqueue({\n      type: 'pageLoaded',\n      url: tab.url,\n      title: tab.title,\n      lastModifiedTime: Date.parse(tab.document.lastModified)\n    });\n  };\n\n  Tracker.prototype.trackTabOpen = function (payload) {\n    this.enqueue(tslib_1.__assign({\n      type: 'tabOpened'\n    }, payload));\n  };\n\n  Tracker.prototype.trackTabUrlChange = function (_a) {\n    var detail = _a.detail;\n    this.enqueue({\n      type: 'tabUrlChanged',\n      tabId: detail.tab.id,\n      url: detail.url\n    });\n  };\n\n  Tracker.prototype.trackTabVisibilityChange = function (_a) {\n    var detail = _a.detail;\n    this.enqueue({\n      type: 'tabVisibilityChanged',\n      tabId: detail.tab.id,\n      visibility: detail.visible ? 'visible' : 'hidden'\n    });\n  };\n\n  Tracker.prototype.trackInactivity = function () {\n    this.enqueue({\n      type: 'nothingChanged',\n      sinceTime: this.inactivityTimer.since\n    });\n  };\n\n  Tracker.prototype.enqueue = function (event, timestamp) {\n    if (timestamp === void 0) {\n      timestamp = Date.now();\n    }\n\n    this.publish(event, timestamp).catch(function () {// suppress error\n    });\n  };\n\n  Tracker.prototype.notifyEvent = function (event) {\n    this.listeners.map(function (listener) {\n      return listener(event);\n    });\n  };\n\n  Tracker.prototype.publish = function (event, timestamp) {\n    var _this = this;\n\n    if (event.type !== 'nothingChanged') {\n      this.stopInactivityTimer();\n    }\n\n    var metadata = this.options.eventMetadata;\n\n    var context = tslib_1.__assign({\n      tabId: this.tab.id,\n      url: this.tab.url\n    }, Object.keys(metadata).length > 0 ? {\n      metadata: metadata\n    } : {});\n\n    var eventInfo = {\n      event: event,\n      context: context,\n      timestamp: timestamp,\n      status: 'pending'\n    };\n\n    if (this.state.suspended) {\n      this.logger.warn(\"Tracker is suspended, ignoring event \\\"\".concat(event.type, \"\\\"\"));\n      this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), {\n        status: 'ignored'\n      }));\n      return Promise.reject(new Error('The tracker is suspended.'));\n    }\n\n    this.logger.info(\"Tracked event \\\"\".concat(event.type, \"\\\"\"));\n    this.notifyEvent(eventInfo);\n    return new Promise(function (resolve, reject) {\n      var promise = _this.channel.publish(_this.createBeacon(event, timestamp, context)).then(function () {\n        _this.logger.debug(\"Successfully published event \\\"\".concat(event.type, \"\\\"\"));\n\n        _this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), {\n          status: 'confirmed'\n        }));\n\n        resolve(event);\n      }, function (cause) {\n        _this.logger.error(\"Failed to publish event \\\"\".concat(event.type, \"\\\", reason: \").concat((0, error_1.formatCause)(cause)));\n\n        _this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), {\n          status: 'failed'\n        }));\n\n        reject(cause);\n      });\n\n      _this.pending.push(promise);\n\n      promise.finally(function () {\n        _this.pending.splice(_this.pending.indexOf(promise), 1);\n      });\n\n      if (_this.state.enabled && event.type !== 'nothingChanged') {\n        _this.startInactivityTimer();\n      }\n    });\n  };\n\n  Tracker.prototype.enrichEvent = function (event, timestamp) {\n    if ((0, trackingEvents_1.isCartPartialEvent)(event)) {\n      var _a = event.cart,\n          _b = _a.lastUpdateTime,\n          lastUpdateTime = _b === void 0 ? timestamp : _b,\n          cart = tslib_1.__rest(_a, [\"lastUpdateTime\"]),\n          payload = tslib_1.__rest(event, [\"cart\"]);\n\n      return tslib_1.__assign(tslib_1.__assign({}, payload), {\n        cart: tslib_1.__assign(tslib_1.__assign({}, cart), {\n          lastUpdateTime: lastUpdateTime\n        })\n      });\n    }\n\n    return event;\n  };\n\n  Tracker.prototype.createBeacon = function (event, timestamp, context) {\n    var token = this.tokenProvider.getToken();\n    return tslib_1.__assign(tslib_1.__assign({\n      timestamp: timestamp\n    }, token !== null ? {\n      token: token.toString()\n    } : {}), {\n      context: context,\n      payload: this.enrichBeaconPayload(this.createBeaconPayload(event))\n    });\n  };\n\n  Tracker.prototype.createBeaconPayload = function (event) {\n    if (!(0, trackingEvents_1.isIdentifiedUserEvent)(event)) {\n      return event;\n    }\n\n    if (event.type === 'userSignedUp' && event.profile !== undefined) {\n      var userId_1 = event.userId,\n          profile = event.profile,\n          payload_1 = tslib_1.__rest(event, [\"userId\", \"profile\"]);\n\n      return tslib_1.__assign(tslib_1.__assign({}, payload_1), {\n        externalUserId: userId_1,\n        patch: {\n          operations: [{\n            type: 'set',\n            path: '.',\n            value: profile\n          }]\n        }\n      });\n    }\n\n    var userId = event.userId,\n        payload = tslib_1.__rest(event, [\"userId\"]);\n\n    return tslib_1.__assign(tslib_1.__assign({}, payload), {\n      externalUserId: userId\n    });\n  };\n\n  Tracker.prototype.enrichBeaconPayload = function (event) {\n    switch (event.type) {\n      case 'linkOpened':\n        return tslib_1.__assign(tslib_1.__assign({}, event), {\n          link: new URL(event.link, this.tab.url).toString()\n        });\n\n      default:\n        return event;\n    }\n  };\n\n  return Tracker;\n}();\n\nexports.Tracker = Tracker;","map":{"version":3,"names":["Object","defineProperty","exports","value","Tracker","tslib_1","require","logging_1","error_1","trackingEvents_1","trackedEvents","_a","_b","tab","tokenProvider","channel","logger","inactivityRetryPolicy","options","__rest","listeners","pending","state","enabled","initialized","suspended","inactivityTimer","since","NullLogger","__assign","eventMetadata","enable","bind","disable","suspend","unsuspend","trackPageLoad","trackTabVisibilityChange","trackTabUrlChange","trackInactivity","prototype","addListener","listener","push","removeListener","index","indexOf","splice","get","suppress","Promise","all","then","enumerable","configurable","isEnabled","isSuspended","info","startInactivityTimer","initialize","stopInactivityTimer","id","undefined","initEvents","isNew","tabOpened","trackTabOpen","tabId","pageOpened","trackPageOpen","url","referrer","window","clearTimeout","_this","Date","now","iteration","startTimer","shouldRetry","setTimeout","getDelay","track","event","timestamp","publish","enrichEvent","payload","enqueue","type","length","detail","title","lastModifiedTime","parse","document","lastModified","visibility","visible","sinceTime","catch","notifyEvent","map","metadata","context","keys","eventInfo","status","warn","concat","reject","Error","resolve","promise","createBeacon","debug","cause","error","formatCause","finally","isCartPartialEvent","cart","lastUpdateTime","token","getToken","toString","enrichBeaconPayload","createBeaconPayload","isIdentifiedUserEvent","profile","userId_1","userId","payload_1","externalUserId","patch","operations","path","link","URL"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/tracker.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Tracker = void 0;\nvar tslib_1 = require(\"tslib\");\nvar logging_1 = require(\"./logging\");\nvar error_1 = require(\"./error\");\nvar trackingEvents_1 = require(\"./trackingEvents\");\nvar trackedEvents = {};\nvar Tracker = /** @class */ (function () {\n    function Tracker(_a) {\n        var _b;\n        var tab = _a.tab, tokenProvider = _a.tokenProvider, channel = _a.channel, logger = _a.logger, inactivityRetryPolicy = _a.inactivityRetryPolicy, options = tslib_1.__rest(_a, [\"tab\", \"tokenProvider\", \"channel\", \"logger\", \"inactivityRetryPolicy\"]);\n        this.listeners = [];\n        this.pending = [];\n        this.state = {\n            enabled: false,\n            initialized: false,\n            suspended: false,\n        };\n        this.inactivityTimer = {\n            since: 0,\n        };\n        this.tab = tab;\n        this.tokenProvider = tokenProvider;\n        this.inactivityRetryPolicy = inactivityRetryPolicy;\n        this.channel = channel;\n        this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n        this.options = tslib_1.__assign(tslib_1.__assign({}, options), { eventMetadata: (_b = options.eventMetadata) !== null && _b !== void 0 ? _b : {} });\n        this.enable = this.enable.bind(this);\n        this.disable = this.disable.bind(this);\n        this.suspend = this.suspend.bind(this);\n        this.unsuspend = this.unsuspend.bind(this);\n        this.trackPageLoad = this.trackPageLoad.bind(this);\n        this.trackTabVisibilityChange = this.trackTabVisibilityChange.bind(this);\n        this.trackTabUrlChange = this.trackTabUrlChange.bind(this);\n        this.trackInactivity = this.trackInactivity.bind(this);\n    }\n    Tracker.prototype.addListener = function (listener) {\n        this.listeners.push(listener);\n    };\n    Tracker.prototype.removeListener = function (listener) {\n        var index = this.listeners.indexOf(listener);\n        while (index >= 0) {\n            this.listeners.splice(index, 1);\n            index = this.listeners.indexOf(listener);\n        }\n    };\n    Object.defineProperty(Tracker.prototype, \"flushed\", {\n        get: function () {\n            var suppress = function () {\n                // suppress errors\n            };\n            return Promise.all(this.pending).then(suppress, suppress);\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Tracker.prototype.isEnabled = function () {\n        return this.state.enabled;\n    };\n    Tracker.prototype.isSuspended = function () {\n        return this.state.suspended;\n    };\n    Tracker.prototype.enable = function () {\n        if (this.state.enabled) {\n            return;\n        }\n        this.logger.info('Tracker enabled');\n        this.state.enabled = true;\n        if (this.state.suspended) {\n            return;\n        }\n        this.startInactivityTimer();\n        if (!this.state.initialized) {\n            this.state.initialized = true;\n            this.initialize();\n        }\n        this.tab.addListener('load', this.trackPageLoad);\n        this.tab.addListener('urlChange', this.trackTabUrlChange);\n        this.tab.addListener('visibilityChange', this.trackTabVisibilityChange);\n    };\n    Tracker.prototype.disable = function () {\n        if (!this.state.enabled) {\n            return;\n        }\n        this.logger.info('Tracker disabled');\n        this.state.enabled = false;\n        if (this.state.suspended) {\n            return;\n        }\n        this.tab.removeListener('load', this.trackPageLoad);\n        this.tab.removeListener('urlChange', this.trackTabUrlChange);\n        this.tab.removeListener('visibilityChange', this.trackTabVisibilityChange);\n        this.stopInactivityTimer();\n    };\n    Tracker.prototype.suspend = function () {\n        if (this.state.suspended) {\n            return;\n        }\n        this.logger.info('Tracker suspended');\n        if (this.state.enabled) {\n            this.disable();\n            this.state.enabled = true;\n        }\n        this.state.suspended = true;\n    };\n    Tracker.prototype.unsuspend = function () {\n        if (!this.state.suspended) {\n            return;\n        }\n        this.logger.info('Tracker unsuspended');\n        this.state.suspended = false;\n        if (this.state.enabled) {\n            this.state.enabled = false;\n            this.enable();\n        }\n    };\n    Tracker.prototype.initialize = function () {\n        if (trackedEvents[this.tab.id] === undefined) {\n            trackedEvents[this.tab.id] = {};\n        }\n        var initEvents = trackedEvents[this.tab.id];\n        if (this.tab.isNew && !initEvents.tabOpened) {\n            initEvents.tabOpened = true;\n            this.trackTabOpen({ tabId: this.tab.id });\n        }\n        if (!initEvents.pageOpened) {\n            initEvents.pageOpened = true;\n            this.trackPageOpen({\n                url: this.tab.url,\n                referrer: this.tab.referrer,\n            });\n        }\n    };\n    Tracker.prototype.stopInactivityTimer = function () {\n        if (this.inactivityTimer.id !== undefined) {\n            window.clearTimeout(this.inactivityTimer.id);\n            delete this.inactivityTimer.id;\n        }\n    };\n    Tracker.prototype.startInactivityTimer = function () {\n        var _this = this;\n        this.stopInactivityTimer();\n        this.inactivityTimer.since = Date.now();\n        var iteration = -1;\n        var startTimer = function () {\n            if (!_this.inactivityRetryPolicy.shouldRetry(iteration + 1, _this.inactivityTimer.since)) {\n                window.clearTimeout(_this.inactivityTimer.id);\n                return;\n            }\n            iteration += 1;\n            _this.inactivityTimer.id = window.setTimeout(function () {\n                _this.trackInactivity();\n                startTimer();\n            }, _this.inactivityRetryPolicy.getDelay(iteration));\n        };\n        startTimer();\n    };\n    Tracker.prototype.track = function (event, timestamp) {\n        if (timestamp === void 0) { timestamp = Date.now(); }\n        return this.publish(this.enrichEvent(event, timestamp), timestamp).then(function () { return event; });\n    };\n    Tracker.prototype.trackPageOpen = function (_a) {\n        var referrer = _a.referrer, payload = tslib_1.__rest(_a, [\"referrer\"]);\n        this.enqueue(tslib_1.__assign(tslib_1.__assign({ type: 'pageOpened' }, payload), (referrer.length > 0 ? { referrer: referrer } : {})));\n    };\n    Tracker.prototype.trackPageLoad = function (_a) {\n        var tab = _a.detail.tab;\n        this.enqueue({\n            type: 'pageLoaded',\n            url: tab.url,\n            title: tab.title,\n            lastModifiedTime: Date.parse(tab.document.lastModified),\n        });\n    };\n    Tracker.prototype.trackTabOpen = function (payload) {\n        this.enqueue(tslib_1.__assign({ type: 'tabOpened' }, payload));\n    };\n    Tracker.prototype.trackTabUrlChange = function (_a) {\n        var detail = _a.detail;\n        this.enqueue({\n            type: 'tabUrlChanged',\n            tabId: detail.tab.id,\n            url: detail.url,\n        });\n    };\n    Tracker.prototype.trackTabVisibilityChange = function (_a) {\n        var detail = _a.detail;\n        this.enqueue({\n            type: 'tabVisibilityChanged',\n            tabId: detail.tab.id,\n            visibility: detail.visible ? 'visible' : 'hidden',\n        });\n    };\n    Tracker.prototype.trackInactivity = function () {\n        this.enqueue({\n            type: 'nothingChanged',\n            sinceTime: this.inactivityTimer.since,\n        });\n    };\n    Tracker.prototype.enqueue = function (event, timestamp) {\n        if (timestamp === void 0) { timestamp = Date.now(); }\n        this.publish(event, timestamp).catch(function () {\n            // suppress error\n        });\n    };\n    Tracker.prototype.notifyEvent = function (event) {\n        this.listeners.map(function (listener) { return listener(event); });\n    };\n    Tracker.prototype.publish = function (event, timestamp) {\n        var _this = this;\n        if (event.type !== 'nothingChanged') {\n            this.stopInactivityTimer();\n        }\n        var metadata = this.options.eventMetadata;\n        var context = tslib_1.__assign({ tabId: this.tab.id, url: this.tab.url }, (Object.keys(metadata).length > 0 ? { metadata: metadata } : {}));\n        var eventInfo = {\n            event: event,\n            context: context,\n            timestamp: timestamp,\n            status: 'pending',\n        };\n        if (this.state.suspended) {\n            this.logger.warn(\"Tracker is suspended, ignoring event \\\"\".concat(event.type, \"\\\"\"));\n            this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), { status: 'ignored' }));\n            return Promise.reject(new Error('The tracker is suspended.'));\n        }\n        this.logger.info(\"Tracked event \\\"\".concat(event.type, \"\\\"\"));\n        this.notifyEvent(eventInfo);\n        return new Promise(function (resolve, reject) {\n            var promise = _this.channel.publish(_this.createBeacon(event, timestamp, context)).then(function () {\n                _this.logger.debug(\"Successfully published event \\\"\".concat(event.type, \"\\\"\"));\n                _this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), { status: 'confirmed' }));\n                resolve(event);\n            }, function (cause) {\n                _this.logger.error(\"Failed to publish event \\\"\".concat(event.type, \"\\\", reason: \").concat((0, error_1.formatCause)(cause)));\n                _this.notifyEvent(tslib_1.__assign(tslib_1.__assign({}, eventInfo), { status: 'failed' }));\n                reject(cause);\n            });\n            _this.pending.push(promise);\n            promise.finally(function () {\n                _this.pending.splice(_this.pending.indexOf(promise), 1);\n            });\n            if (_this.state.enabled && event.type !== 'nothingChanged') {\n                _this.startInactivityTimer();\n            }\n        });\n    };\n    Tracker.prototype.enrichEvent = function (event, timestamp) {\n        if ((0, trackingEvents_1.isCartPartialEvent)(event)) {\n            var _a = event.cart, _b = _a.lastUpdateTime, lastUpdateTime = _b === void 0 ? timestamp : _b, cart = tslib_1.__rest(_a, [\"lastUpdateTime\"]), payload = tslib_1.__rest(event, [\"cart\"]);\n            return tslib_1.__assign(tslib_1.__assign({}, payload), { cart: tslib_1.__assign(tslib_1.__assign({}, cart), { lastUpdateTime: lastUpdateTime }) });\n        }\n        return event;\n    };\n    Tracker.prototype.createBeacon = function (event, timestamp, context) {\n        var token = this.tokenProvider.getToken();\n        return tslib_1.__assign(tslib_1.__assign({ timestamp: timestamp }, (token !== null ? { token: token.toString() } : {})), { context: context, payload: this.enrichBeaconPayload(this.createBeaconPayload(event)) });\n    };\n    Tracker.prototype.createBeaconPayload = function (event) {\n        if (!(0, trackingEvents_1.isIdentifiedUserEvent)(event)) {\n            return event;\n        }\n        if (event.type === 'userSignedUp' && event.profile !== undefined) {\n            var userId_1 = event.userId, profile = event.profile, payload_1 = tslib_1.__rest(event, [\"userId\", \"profile\"]);\n            return tslib_1.__assign(tslib_1.__assign({}, payload_1), { externalUserId: userId_1, patch: {\n                    operations: [\n                        {\n                            type: 'set',\n                            path: '.',\n                            value: profile,\n                        },\n                    ],\n                } });\n        }\n        var userId = event.userId, payload = tslib_1.__rest(event, [\"userId\"]);\n        return tslib_1.__assign(tslib_1.__assign({}, payload), { externalUserId: userId });\n    };\n    Tracker.prototype.enrichBeaconPayload = function (event) {\n        switch (event.type) {\n            case 'linkOpened':\n                return tslib_1.__assign(tslib_1.__assign({}, event), { link: new URL(event.link, this.tab.url).toString() });\n            default:\n                return event;\n        }\n    };\n    return Tracker;\n}());\nexports.Tracker = Tracker;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}
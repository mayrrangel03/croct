{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BeaconSocketChannel = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar logging_1 = require(\"../logging\");\n\nvar BeaconSocketChannel =\n/** @class */\nfunction () {\n  function BeaconSocketChannel(configuration) {\n    var _a, _b;\n\n    this.listeners = [];\n    this.connectionIndex = 0;\n    this.socketFactory = configuration.channelFactory;\n    this.logger = (_a = configuration.logger) !== null && _a !== void 0 ? _a : new logging_1.NullLogger();\n    this.loggerFactory = (_b = configuration.loggerFactory) !== null && _b !== void 0 ? _b : function () {\n      return new logging_1.NullLogger();\n    };\n    this.cidAssigner = configuration.cidAssigner;\n    this.cidParameter = configuration.cidParameter;\n    this.trackerEndpointUrl = configuration.trackerEndpointUrl;\n    this.tokenParameter = configuration.tokenParameter;\n    this.notify = this.notify.bind(this);\n  }\n\n  BeaconSocketChannel.prototype.publish = function (_a) {\n    var receiptId = _a.id,\n        message = _a.message;\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var _b, token, timestamp, context, payload, _c;\n\n      return tslib_1.__generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            _b = JSON.parse(message), token = _b.token, timestamp = _b.timestamp, context = _b.context, payload = _b.payload;\n            if (!(this.token !== token || this.socketChannel === undefined)) return [3\n            /*break*/\n            , 4];\n            if (!(this.socketChannel !== undefined)) return [3\n            /*break*/\n            , 2];\n            this.logger.info('Connection no longer valid for current message.');\n            this.socketChannel.unsubscribe(this.notify);\n            return [4\n            /*yield*/\n            , this.socketChannel.close()];\n\n          case 1:\n            _d.sent();\n\n            _d.label = 2;\n\n          case 2:\n            this.token = token;\n            _c = this;\n            return [4\n            /*yield*/\n            , this.createSocketChannel(token)];\n\n          case 3:\n            _c.socketChannel = _d.sent();\n            _d.label = 4;\n\n          case 4:\n            return [2\n            /*return*/\n            , this.socketChannel.publish(JSON.stringify({\n              receiptId: receiptId,\n              originalTime: timestamp,\n              departureTime: Date.now(),\n              context: context,\n              payload: payload\n            }))];\n        }\n      });\n    });\n  };\n\n  BeaconSocketChannel.prototype.createSocketChannel = function (token) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var endpoint, _a, _b, _c, channel;\n\n      return tslib_1.__generator(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            endpoint = new URL(this.trackerEndpointUrl);\n            _b = (_a = endpoint.searchParams).append;\n            _c = [this.cidParameter];\n            return [4\n            /*yield*/\n            , this.cidAssigner.assignCid()];\n\n          case 1:\n            _b.apply(_a, _c.concat([_d.sent()]));\n\n            if (token !== undefined) {\n              endpoint.searchParams.append(this.tokenParameter, token);\n            }\n\n            channel = this.socketFactory(endpoint.toString(), this.loggerFactory(\"WebSocket#\".concat(this.connectionIndex)));\n            this.connectionIndex += 1;\n            channel.subscribe(this.notify);\n            return [2\n            /*return*/\n            , channel];\n        }\n      });\n    });\n  };\n\n  BeaconSocketChannel.prototype.subscribe = function (listener) {\n    if (!this.listeners.includes(listener)) {\n      this.listeners.push(listener);\n    }\n  };\n\n  BeaconSocketChannel.prototype.unsubscribe = function (listener) {\n    var index = this.listeners.indexOf(listener);\n\n    if (index >= 0) {\n      this.listeners.splice(index, 1);\n    }\n  };\n\n  BeaconSocketChannel.prototype.notify = function (message) {\n    var _this = this;\n\n    var confirmation;\n\n    try {\n      confirmation = JSON.parse(message);\n    } catch (_a) {\n      this.logger.error('Invalid JSON message received.');\n      return;\n    }\n\n    var _b = confirmation.violations,\n        violations = _b === void 0 ? [] : _b,\n        receiptId = confirmation.receiptId;\n    violations.forEach(function (violation) {\n      return _this.logger.error(violation.message);\n    });\n\n    if (receiptId !== null) {\n      this.listeners.forEach(function (dispatch) {\n        return dispatch(receiptId);\n      });\n    }\n  };\n\n  BeaconSocketChannel.prototype.close = function () {\n    if (this.socketChannel === undefined) {\n      return Promise.resolve();\n    }\n\n    return this.socketChannel.close();\n  };\n\n  return BeaconSocketChannel;\n}();\n\nexports.BeaconSocketChannel = BeaconSocketChannel;","map":{"version":3,"names":["Object","defineProperty","exports","value","BeaconSocketChannel","tslib_1","require","logging_1","configuration","_a","_b","listeners","connectionIndex","socketFactory","channelFactory","logger","NullLogger","loggerFactory","cidAssigner","cidParameter","trackerEndpointUrl","tokenParameter","notify","bind","prototype","publish","receiptId","id","message","__awaiter","token","timestamp","context","payload","_c","__generator","_d","label","JSON","parse","socketChannel","undefined","info","unsubscribe","close","sent","createSocketChannel","stringify","originalTime","departureTime","Date","now","endpoint","channel","URL","searchParams","append","assignCid","apply","concat","toString","subscribe","listener","includes","push","index","indexOf","splice","_this","confirmation","error","violations","forEach","violation","dispatch","Promise","resolve"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/channel/beaconSocketChannel.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.BeaconSocketChannel = void 0;\nvar tslib_1 = require(\"tslib\");\nvar logging_1 = require(\"../logging\");\nvar BeaconSocketChannel = /** @class */ (function () {\n    function BeaconSocketChannel(configuration) {\n        var _a, _b;\n        this.listeners = [];\n        this.connectionIndex = 0;\n        this.socketFactory = configuration.channelFactory;\n        this.logger = (_a = configuration.logger) !== null && _a !== void 0 ? _a : new logging_1.NullLogger();\n        this.loggerFactory = (_b = configuration.loggerFactory) !== null && _b !== void 0 ? _b : (function () { return new logging_1.NullLogger(); });\n        this.cidAssigner = configuration.cidAssigner;\n        this.cidParameter = configuration.cidParameter;\n        this.trackerEndpointUrl = configuration.trackerEndpointUrl;\n        this.tokenParameter = configuration.tokenParameter;\n        this.notify = this.notify.bind(this);\n    }\n    BeaconSocketChannel.prototype.publish = function (_a) {\n        var receiptId = _a.id, message = _a.message;\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _b, token, timestamp, context, payload, _c;\n            return tslib_1.__generator(this, function (_d) {\n                switch (_d.label) {\n                    case 0:\n                        _b = JSON.parse(message), token = _b.token, timestamp = _b.timestamp, context = _b.context, payload = _b.payload;\n                        if (!(this.token !== token || this.socketChannel === undefined)) return [3 /*break*/, 4];\n                        if (!(this.socketChannel !== undefined)) return [3 /*break*/, 2];\n                        this.logger.info('Connection no longer valid for current message.');\n                        this.socketChannel.unsubscribe(this.notify);\n                        return [4 /*yield*/, this.socketChannel.close()];\n                    case 1:\n                        _d.sent();\n                        _d.label = 2;\n                    case 2:\n                        this.token = token;\n                        _c = this;\n                        return [4 /*yield*/, this.createSocketChannel(token)];\n                    case 3:\n                        _c.socketChannel = _d.sent();\n                        _d.label = 4;\n                    case 4: return [2 /*return*/, this.socketChannel.publish(JSON.stringify({\n                            receiptId: receiptId,\n                            originalTime: timestamp,\n                            departureTime: Date.now(),\n                            context: context,\n                            payload: payload,\n                        }))];\n                }\n            });\n        });\n    };\n    BeaconSocketChannel.prototype.createSocketChannel = function (token) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var endpoint, _a, _b, _c, channel;\n            return tslib_1.__generator(this, function (_d) {\n                switch (_d.label) {\n                    case 0:\n                        endpoint = new URL(this.trackerEndpointUrl);\n                        _b = (_a = endpoint.searchParams).append;\n                        _c = [this.cidParameter];\n                        return [4 /*yield*/, this.cidAssigner.assignCid()];\n                    case 1:\n                        _b.apply(_a, _c.concat([_d.sent()]));\n                        if (token !== undefined) {\n                            endpoint.searchParams.append(this.tokenParameter, token);\n                        }\n                        channel = this.socketFactory(endpoint.toString(), this.loggerFactory(\"WebSocket#\".concat(this.connectionIndex)));\n                        this.connectionIndex += 1;\n                        channel.subscribe(this.notify);\n                        return [2 /*return*/, channel];\n                }\n            });\n        });\n    };\n    BeaconSocketChannel.prototype.subscribe = function (listener) {\n        if (!this.listeners.includes(listener)) {\n            this.listeners.push(listener);\n        }\n    };\n    BeaconSocketChannel.prototype.unsubscribe = function (listener) {\n        var index = this.listeners.indexOf(listener);\n        if (index >= 0) {\n            this.listeners.splice(index, 1);\n        }\n    };\n    BeaconSocketChannel.prototype.notify = function (message) {\n        var _this = this;\n        var confirmation;\n        try {\n            confirmation = JSON.parse(message);\n        }\n        catch (_a) {\n            this.logger.error('Invalid JSON message received.');\n            return;\n        }\n        var _b = confirmation.violations, violations = _b === void 0 ? [] : _b, receiptId = confirmation.receiptId;\n        violations.forEach(function (violation) { return _this.logger.error(violation.message); });\n        if (receiptId !== null) {\n            this.listeners.forEach(function (dispatch) { return dispatch(receiptId); });\n        }\n    };\n    BeaconSocketChannel.prototype.close = function () {\n        if (this.socketChannel === undefined) {\n            return Promise.resolve();\n        }\n        return this.socketChannel.close();\n    };\n    return BeaconSocketChannel;\n}());\nexports.BeaconSocketChannel = BeaconSocketChannel;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}
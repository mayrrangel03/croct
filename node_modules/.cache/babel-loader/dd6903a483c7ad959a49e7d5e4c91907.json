{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RetryChannel = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar logging_1 = require(\"../logging\");\n\nvar RetryChannel =\n/** @class */\nfunction () {\n  function RetryChannel(_a) {\n    var channel = _a.channel,\n        retryPolicy = _a.retryPolicy,\n        logger = _a.logger;\n    this.closed = false;\n    this.channel = channel;\n    this.retryPolicy = retryPolicy;\n    this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n  }\n\n  RetryChannel.prototype.publish = function (message) {\n    var _this = this;\n\n    if (this.closed) {\n      return Promise.reject(new Error('The channel is closed.'));\n    }\n\n    return this.channel.publish(message).catch(function (error) {\n      return _this.retry(message, error);\n    });\n  };\n\n  RetryChannel.prototype.retry = function (message, error) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var attempt, _loop_1, this_1, state_1;\n\n      var _this = this;\n\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            attempt = 0;\n\n            _loop_1 = function () {\n              var delay, _b, _c;\n\n              return tslib_1.__generator(this, function (_d) {\n                switch (_d.label) {\n                  case 0:\n                    if (this_1.closed) {\n                      throw new Error('Connection deliberately closed.');\n                    }\n\n                    delay = this_1.retryPolicy.getDelay(attempt);\n                    this_1.logger.debug(\"Retry attempt \".concat(attempt + 1));\n                    if (!(delay > 0)) return [3\n                    /*break*/\n                    , 2];\n                    this_1.logger.debug(\"Retry attempt delayed in \".concat(delay, \"ms\"));\n                    return [4\n                    /*yield*/\n                    , new Promise(function (resolve, reject) {\n                      var closeWatcher = window.setInterval(function () {\n                        if (_this.closed) {\n                          // Cancel delay immediately when the channel is closed\n                          window.clearInterval(closeWatcher);\n                          reject(new Error('Connection deliberately closed.'));\n                        }\n                      }, 0);\n                      window.setTimeout(function () {\n                        window.clearInterval(closeWatcher);\n                        resolve();\n                      }, delay);\n                    })];\n\n                  case 1:\n                    _d.sent();\n\n                    _d.label = 2;\n\n                  case 2:\n                    _d.trys.push([2, 4,, 5]);\n\n                    _b = {};\n                    return [4\n                    /*yield*/\n                    , this_1.channel.publish(message)];\n\n                  case 3:\n                    return [2\n                    /*return*/\n                    , (_b.value = _d.sent(), _b)];\n\n                  case 4:\n                    _c = _d.sent();\n                    attempt += 1;\n                    return [3\n                    /*break*/\n                    , 5];\n\n                  case 5:\n                    return [2\n                    /*return*/\n                    ];\n                }\n              });\n            };\n\n            this_1 = this;\n            _a.label = 1;\n\n          case 1:\n            if (!this.retryPolicy.shouldRetry(attempt, message, error)) return [3\n            /*break*/\n            , 3];\n            return [5\n            /*yield**/\n            , _loop_1()];\n\n          case 2:\n            state_1 = _a.sent();\n            if (typeof state_1 === \"object\") return [2\n            /*return*/\n            , state_1.value];\n            return [3\n            /*break*/\n            , 1];\n\n          case 3:\n            throw new Error('Maximum retry attempts reached.');\n        }\n      });\n    });\n  };\n\n  RetryChannel.prototype.close = function () {\n    this.closed = true;\n    return this.channel.close();\n  };\n\n  return RetryChannel;\n}();\n\nexports.RetryChannel = RetryChannel;","map":{"version":3,"names":["Object","defineProperty","exports","value","RetryChannel","tslib_1","require","logging_1","_a","channel","retryPolicy","logger","closed","NullLogger","prototype","publish","message","_this","Promise","reject","Error","catch","error","retry","__awaiter","attempt","_loop_1","this_1","state_1","__generator","label","delay","_b","_c","_d","getDelay","debug","concat","resolve","closeWatcher","window","setInterval","clearInterval","setTimeout","sent","trys","push","shouldRetry","close"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/channel/retryChannel.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.RetryChannel = void 0;\nvar tslib_1 = require(\"tslib\");\nvar logging_1 = require(\"../logging\");\nvar RetryChannel = /** @class */ (function () {\n    function RetryChannel(_a) {\n        var channel = _a.channel, retryPolicy = _a.retryPolicy, logger = _a.logger;\n        this.closed = false;\n        this.channel = channel;\n        this.retryPolicy = retryPolicy;\n        this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n    }\n    RetryChannel.prototype.publish = function (message) {\n        var _this = this;\n        if (this.closed) {\n            return Promise.reject(new Error('The channel is closed.'));\n        }\n        return this.channel.publish(message).catch(function (error) { return _this.retry(message, error); });\n    };\n    RetryChannel.prototype.retry = function (message, error) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var attempt, _loop_1, this_1, state_1;\n            var _this = this;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        attempt = 0;\n                        _loop_1 = function () {\n                            var delay, _b, _c;\n                            return tslib_1.__generator(this, function (_d) {\n                                switch (_d.label) {\n                                    case 0:\n                                        if (this_1.closed) {\n                                            throw new Error('Connection deliberately closed.');\n                                        }\n                                        delay = this_1.retryPolicy.getDelay(attempt);\n                                        this_1.logger.debug(\"Retry attempt \".concat(attempt + 1));\n                                        if (!(delay > 0)) return [3 /*break*/, 2];\n                                        this_1.logger.debug(\"Retry attempt delayed in \".concat(delay, \"ms\"));\n                                        return [4 /*yield*/, new Promise(function (resolve, reject) {\n                                                var closeWatcher = window.setInterval(function () {\n                                                    if (_this.closed) {\n                                                        // Cancel delay immediately when the channel is closed\n                                                        window.clearInterval(closeWatcher);\n                                                        reject(new Error('Connection deliberately closed.'));\n                                                    }\n                                                }, 0);\n                                                window.setTimeout(function () {\n                                                    window.clearInterval(closeWatcher);\n                                                    resolve();\n                                                }, delay);\n                                            })];\n                                    case 1:\n                                        _d.sent();\n                                        _d.label = 2;\n                                    case 2:\n                                        _d.trys.push([2, 4, , 5]);\n                                        _b = {};\n                                        return [4 /*yield*/, this_1.channel.publish(message)];\n                                    case 3: return [2 /*return*/, (_b.value = _d.sent(), _b)];\n                                    case 4:\n                                        _c = _d.sent();\n                                        attempt += 1;\n                                        return [3 /*break*/, 5];\n                                    case 5: return [2 /*return*/];\n                                }\n                            });\n                        };\n                        this_1 = this;\n                        _a.label = 1;\n                    case 1:\n                        if (!this.retryPolicy.shouldRetry(attempt, message, error)) return [3 /*break*/, 3];\n                        return [5 /*yield**/, _loop_1()];\n                    case 2:\n                        state_1 = _a.sent();\n                        if (typeof state_1 === \"object\")\n                            return [2 /*return*/, state_1.value];\n                        return [3 /*break*/, 1];\n                    case 3: throw new Error('Maximum retry attempts reached.');\n                }\n            });\n        });\n    };\n    RetryChannel.prototype.close = function () {\n        this.closed = true;\n        return this.channel.close();\n    };\n    return RetryChannel;\n}());\nexports.RetryChannel = RetryChannel;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}
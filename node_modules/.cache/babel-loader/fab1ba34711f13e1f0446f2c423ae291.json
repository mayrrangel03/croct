{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.QueuedChannel = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar logging_1 = require(\"../logging\");\n\nvar QueuedChannel =\n/** @class */\nfunction () {\n  function QueuedChannel(channel, queue, logger) {\n    this.closed = false;\n    this.channel = channel;\n    this.queue = queue;\n    this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n  }\n\n  QueuedChannel.prototype.flush = function () {\n    if (this.pending === undefined) {\n      return this.requeue();\n    }\n\n    return this.pending.catch(this.requeue.bind(this));\n  };\n\n  QueuedChannel.prototype.publish = function (message) {\n    var _this = this;\n\n    if (this.closed) {\n      return Promise.reject(new Error('Channel is closed.'));\n    }\n\n    if (this.queue.length() >= this.queue.getCapacity()) {\n      this.logger.warn('The queue is full, message rejected.');\n      return Promise.reject(new Error('The queue is full.'));\n    }\n\n    if (this.pending === undefined) {\n      this.pending = this.queue.isEmpty() ? Promise.resolve() : Promise.reject(new Error('The queue must be flushed.'));\n    }\n\n    this.enqueue(message);\n    this.pending = this.pending.then(function () {\n      return _this.channel.publish(message).then(_this.dequeue.bind(_this));\n    });\n    return this.pending;\n  };\n\n  QueuedChannel.prototype.enqueue = function (message) {\n    this.logger.debug('Enqueueing message...');\n    this.logger.debug(\"Queue length: \".concat(this.queue.length() + 1));\n    this.queue.push(message);\n  };\n\n  QueuedChannel.prototype.dequeue = function () {\n    this.logger.debug('Dequeuing message...');\n    this.logger.debug(\"Queue length: \".concat(Math.max(0, this.queue.length() - 1)));\n    this.queue.shift();\n  };\n\n  QueuedChannel.prototype.requeue = function () {\n    var e_1, _a;\n\n    var _this = this;\n\n    if (this.closed) {\n      return Promise.reject(new Error('Channel is closed.'));\n    }\n\n    this.pending = Promise.resolve();\n\n    if (this.queue.isEmpty()) {\n      return this.pending;\n    }\n\n    var length = this.queue.length();\n    this.logger.debug('Requeuing messages...');\n    this.logger.debug(\"Queue length: \".concat(length));\n\n    var _loop_1 = function (message) {\n      this_1.pending = this_1.pending.then(function () {\n        return _this.channel.publish(message).then(_this.dequeue.bind(_this));\n      });\n    };\n\n    var this_1 = this;\n\n    try {\n      for (var _b = tslib_1.__values(this.queue.all()), _c = _b.next(); !_c.done; _c = _b.next()) {\n        var message = _c.value;\n\n        _loop_1(message);\n      }\n    } catch (e_1_1) {\n      e_1 = {\n        error: e_1_1\n      };\n    } finally {\n      try {\n        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n      } finally {\n        if (e_1) throw e_1.error;\n      }\n    }\n\n    return this.pending;\n  };\n\n  QueuedChannel.prototype.close = function () {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var _a;\n\n      return tslib_1.__generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            this.closed = true;\n            return [4\n            /*yield*/\n            , this.channel.close()];\n\n          case 1:\n            _b.sent();\n\n            if (!(this.pending !== undefined)) return [3\n            /*break*/\n            , 5];\n            _b.label = 2;\n\n          case 2:\n            _b.trys.push([2, 4,, 5]);\n\n            return [4\n            /*yield*/\n            , this.pending];\n\n          case 3:\n            _b.sent();\n\n            return [3\n            /*break*/\n            , 5];\n\n          case 4:\n            _a = _b.sent();\n            return [3\n            /*break*/\n            , 5];\n\n          case 5:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  return QueuedChannel;\n}();\n\nexports.QueuedChannel = QueuedChannel;","map":{"version":3,"names":["Object","defineProperty","exports","value","QueuedChannel","tslib_1","require","logging_1","channel","queue","logger","closed","NullLogger","prototype","flush","pending","undefined","requeue","catch","bind","publish","message","_this","Promise","reject","Error","length","getCapacity","warn","isEmpty","resolve","enqueue","then","dequeue","debug","concat","push","Math","max","shift","e_1","_a","_loop_1","this_1","_b","__values","all","_c","next","done","e_1_1","error","return","call","close","__awaiter","__generator","label","sent","trys"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/channel/queuedChannel.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.QueuedChannel = void 0;\nvar tslib_1 = require(\"tslib\");\nvar logging_1 = require(\"../logging\");\nvar QueuedChannel = /** @class */ (function () {\n    function QueuedChannel(channel, queue, logger) {\n        this.closed = false;\n        this.channel = channel;\n        this.queue = queue;\n        this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n    }\n    QueuedChannel.prototype.flush = function () {\n        if (this.pending === undefined) {\n            return this.requeue();\n        }\n        return this.pending.catch(this.requeue.bind(this));\n    };\n    QueuedChannel.prototype.publish = function (message) {\n        var _this = this;\n        if (this.closed) {\n            return Promise.reject(new Error('Channel is closed.'));\n        }\n        if (this.queue.length() >= this.queue.getCapacity()) {\n            this.logger.warn('The queue is full, message rejected.');\n            return Promise.reject(new Error('The queue is full.'));\n        }\n        if (this.pending === undefined) {\n            this.pending = this.queue.isEmpty()\n                ? Promise.resolve()\n                : Promise.reject(new Error('The queue must be flushed.'));\n        }\n        this.enqueue(message);\n        this.pending = this.pending.then(function () { return _this.channel.publish(message).then(_this.dequeue.bind(_this)); });\n        return this.pending;\n    };\n    QueuedChannel.prototype.enqueue = function (message) {\n        this.logger.debug('Enqueueing message...');\n        this.logger.debug(\"Queue length: \".concat(this.queue.length() + 1));\n        this.queue.push(message);\n    };\n    QueuedChannel.prototype.dequeue = function () {\n        this.logger.debug('Dequeuing message...');\n        this.logger.debug(\"Queue length: \".concat(Math.max(0, this.queue.length() - 1)));\n        this.queue.shift();\n    };\n    QueuedChannel.prototype.requeue = function () {\n        var e_1, _a;\n        var _this = this;\n        if (this.closed) {\n            return Promise.reject(new Error('Channel is closed.'));\n        }\n        this.pending = Promise.resolve();\n        if (this.queue.isEmpty()) {\n            return this.pending;\n        }\n        var length = this.queue.length();\n        this.logger.debug('Requeuing messages...');\n        this.logger.debug(\"Queue length: \".concat(length));\n        var _loop_1 = function (message) {\n            this_1.pending = this_1.pending.then(function () { return _this.channel.publish(message).then(_this.dequeue.bind(_this)); });\n        };\n        var this_1 = this;\n        try {\n            for (var _b = tslib_1.__values(this.queue.all()), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var message = _c.value;\n                _loop_1(message);\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n        return this.pending;\n    };\n    QueuedChannel.prototype.close = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var _a;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        this.closed = true;\n                        return [4 /*yield*/, this.channel.close()];\n                    case 1:\n                        _b.sent();\n                        if (!(this.pending !== undefined)) return [3 /*break*/, 5];\n                        _b.label = 2;\n                    case 2:\n                        _b.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, this.pending];\n                    case 3:\n                        _b.sent();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        _a = _b.sent();\n                        return [3 /*break*/, 5];\n                    case 5: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return QueuedChannel;\n}());\nexports.QueuedChannel = QueuedChannel;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}
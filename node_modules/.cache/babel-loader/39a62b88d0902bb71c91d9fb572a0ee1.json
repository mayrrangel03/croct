{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.GuaranteedChannel = exports.TimeStamper = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar logging_1 = require(\"../logging\");\n\nvar TimeStamper =\n/** @class */\nfunction () {\n  function TimeStamper() {}\n\n  TimeStamper.prototype.generate = function () {\n    return String(Date.now());\n  };\n\n  return TimeStamper;\n}();\n\nexports.TimeStamper = TimeStamper;\n\nvar GuaranteedChannel =\n/** @class */\nfunction () {\n  function GuaranteedChannel(_a) {\n    var _b;\n\n    var channel = _a.channel,\n        logger = _a.logger,\n        stamper = _a.stamper,\n        options = tslib_1.__rest(_a, [\"channel\", \"logger\", \"stamper\"]);\n\n    this.closed = false;\n    this.channel = channel;\n    this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n    this.stamper = stamper;\n    this.options = tslib_1.__assign(tslib_1.__assign({}, options), {\n      ackTimeout: (_b = options.ackTimeout) !== null && _b !== void 0 ? _b : 5000\n    });\n  }\n\n  GuaranteedChannel.prototype.publish = function (message) {\n    var _this = this;\n\n    if (this.closed) {\n      return Promise.reject(new Error('Channel is closed.'));\n    }\n\n    return new Promise(function (resolve, reject) {\n      var id = _this.stamper.generate(message);\n\n      var timeoutTimer;\n      var closeWatcher;\n      var confirmed = false;\n      var start = Date.now();\n\n      var acknowledge = function (response) {\n        if (response === id) {\n          confirmed = true;\n          var elapsed = Date.now() - start;\n          window.clearTimeout(timeoutTimer);\n          window.clearInterval(closeWatcher);\n\n          _this.logger.debug(\"Delivery confirmed #\".concat(id, \", elapsed \").concat(elapsed, \"ms.\"));\n\n          _this.channel.unsubscribe(acknowledge);\n\n          resolve();\n        }\n      };\n\n      _this.channel.subscribe(acknowledge);\n\n      var abort = function (error) {\n        window.clearTimeout(timeoutTimer);\n        window.clearInterval(closeWatcher);\n\n        _this.logger.error(\"Failed to send message #\".concat(id));\n\n        _this.channel.unsubscribe(acknowledge);\n\n        reject(error);\n      };\n\n      var wait = function () {\n        if (confirmed) {\n          return;\n        }\n\n        closeWatcher = window.setInterval(function () {\n          if (_this.closed) {\n            // Cancel delay immediately when the channel is closed\n            abort(new Error('Connection deliberately closed.'));\n          }\n        }, 0);\n\n        _this.logger.debug(\"Waiting confirmation #\".concat(id, \"...\"));\n\n        timeoutTimer = window.setTimeout(function () {\n          abort(new Error('Maximum confirmation time reached.'));\n        }, _this.options.ackTimeout);\n      };\n\n      _this.logger.debug(\"Sending message #\".concat(id, \"...\"));\n\n      _this.channel.publish({\n        id: id,\n        message: message\n      }).then(wait, abort);\n    });\n  };\n\n  GuaranteedChannel.prototype.close = function () {\n    this.closed = true;\n    return this.channel.close();\n  };\n\n  return GuaranteedChannel;\n}();\n\nexports.GuaranteedChannel = GuaranteedChannel;","map":{"version":3,"names":["Object","defineProperty","exports","value","GuaranteedChannel","TimeStamper","tslib_1","require","logging_1","prototype","generate","String","Date","now","_a","_b","channel","logger","stamper","options","__rest","closed","NullLogger","__assign","ackTimeout","publish","message","_this","Promise","reject","Error","resolve","id","timeoutTimer","closeWatcher","confirmed","start","acknowledge","response","elapsed","window","clearTimeout","clearInterval","debug","concat","unsubscribe","subscribe","abort","error","wait","setInterval","setTimeout","then","close"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/channel/guaranteedChannel.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.GuaranteedChannel = exports.TimeStamper = void 0;\nvar tslib_1 = require(\"tslib\");\nvar logging_1 = require(\"../logging\");\nvar TimeStamper = /** @class */ (function () {\n    function TimeStamper() {\n    }\n    TimeStamper.prototype.generate = function () {\n        return String(Date.now());\n    };\n    return TimeStamper;\n}());\nexports.TimeStamper = TimeStamper;\nvar GuaranteedChannel = /** @class */ (function () {\n    function GuaranteedChannel(_a) {\n        var _b;\n        var channel = _a.channel, logger = _a.logger, stamper = _a.stamper, options = tslib_1.__rest(_a, [\"channel\", \"logger\", \"stamper\"]);\n        this.closed = false;\n        this.channel = channel;\n        this.logger = logger !== null && logger !== void 0 ? logger : new logging_1.NullLogger();\n        this.stamper = stamper;\n        this.options = tslib_1.__assign(tslib_1.__assign({}, options), { ackTimeout: (_b = options.ackTimeout) !== null && _b !== void 0 ? _b : 5000 });\n    }\n    GuaranteedChannel.prototype.publish = function (message) {\n        var _this = this;\n        if (this.closed) {\n            return Promise.reject(new Error('Channel is closed.'));\n        }\n        return new Promise(function (resolve, reject) {\n            var id = _this.stamper.generate(message);\n            var timeoutTimer;\n            var closeWatcher;\n            var confirmed = false;\n            var start = Date.now();\n            var acknowledge = function (response) {\n                if (response === id) {\n                    confirmed = true;\n                    var elapsed = Date.now() - start;\n                    window.clearTimeout(timeoutTimer);\n                    window.clearInterval(closeWatcher);\n                    _this.logger.debug(\"Delivery confirmed #\".concat(id, \", elapsed \").concat(elapsed, \"ms.\"));\n                    _this.channel.unsubscribe(acknowledge);\n                    resolve();\n                }\n            };\n            _this.channel.subscribe(acknowledge);\n            var abort = function (error) {\n                window.clearTimeout(timeoutTimer);\n                window.clearInterval(closeWatcher);\n                _this.logger.error(\"Failed to send message #\".concat(id));\n                _this.channel.unsubscribe(acknowledge);\n                reject(error);\n            };\n            var wait = function () {\n                if (confirmed) {\n                    return;\n                }\n                closeWatcher = window.setInterval(function () {\n                    if (_this.closed) {\n                        // Cancel delay immediately when the channel is closed\n                        abort(new Error('Connection deliberately closed.'));\n                    }\n                }, 0);\n                _this.logger.debug(\"Waiting confirmation #\".concat(id, \"...\"));\n                timeoutTimer = window.setTimeout(function () {\n                    abort(new Error('Maximum confirmation time reached.'));\n                }, _this.options.ackTimeout);\n            };\n            _this.logger.debug(\"Sending message #\".concat(id, \"...\"));\n            _this.channel.publish({ id: id, message: message }).then(wait, abort);\n        });\n    };\n    GuaranteedChannel.prototype.close = function () {\n        this.closed = true;\n        return this.channel.close();\n    };\n    return GuaranteedChannel;\n}());\nexports.GuaranteedChannel = GuaranteedChannel;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}
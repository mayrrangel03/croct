{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Context = void 0;\n\nvar token_1 = require(\"./token\");\n\nvar tab_1 = require(\"./tab\");\n\nvar uuid_1 = require(\"./uuid\");\n\nfunction tokenEquals(left, right) {\n  return left === right || left !== null && right !== null && left.toString() === right.toString();\n}\n\nvar Context =\n/** @class */\nfunction () {\n  function Context(tab, tokenStore, eventDispatcher) {\n    this.tab = tab;\n    this.tokenStore = tokenStore;\n    this.eventDispatcher = eventDispatcher;\n    this.lastToken = tokenStore.getToken();\n    this.syncToken = this.syncToken.bind(this);\n  }\n\n  Context.load = function (_a) {\n    var cache = _a.cache,\n        tokenScope = _a.tokenScope,\n        eventDispatcher = _a.eventDispatcher,\n        urlSanitizer = _a.urlSanitizer;\n    var tabId = cache.tabId.get();\n    var newTab = false;\n\n    if (tabId === null) {\n      tabId = (0, uuid_1.uuid4)(true);\n      newTab = true;\n    }\n\n    var tab = new tab_1.Tab(tabId, newTab, urlSanitizer);\n    cache.tabId.clear();\n    tab.addListener('unload', function () {\n      return cache.tabId.put(tab.id);\n    });\n\n    switch (tokenScope) {\n      case 'isolated':\n        return new Context(tab, new token_1.InMemoryTokenStore(), eventDispatcher);\n\n      case 'global':\n        {\n          var context = new Context(tab, new token_1.CachedTokenStore(cache.browserToken), eventDispatcher);\n          cache.browserToken.addListener(context.syncToken);\n          return context;\n        }\n\n      case 'contextual':\n        {\n          var primaryStorage_1 = new token_1.CachedTokenStore(cache.tabToken);\n          var secondaryStorage_1 = new token_1.CachedTokenStore(cache.browserToken);\n\n          if (tab.isNew) {\n            primaryStorage_1.setToken(secondaryStorage_1.getToken());\n          }\n\n          tab.addListener('visibilityChange', function (event) {\n            if (event.detail.visible) {\n              secondaryStorage_1.setToken(primaryStorage_1.getToken());\n            }\n          });\n          return new Context(tab, new token_1.ReplicatedTokenStore(primaryStorage_1, secondaryStorage_1), eventDispatcher);\n        }\n    }\n  };\n\n  Context.prototype.getTab = function () {\n    return this.tab;\n  };\n\n  Context.prototype.isAnonymous = function () {\n    var token = this.getToken();\n    return token == null || token.isAnonymous();\n  };\n\n  Context.prototype.getUser = function () {\n    var token = this.getToken();\n    return token == null ? null : token.getSubject();\n  };\n\n  Context.prototype.getToken = function () {\n    return this.tokenStore.getToken();\n  };\n\n  Context.prototype.setToken = function (token) {\n    var oldToken = this.lastToken;\n    this.lastToken = token;\n    this.tokenStore.setToken(token);\n\n    if (!tokenEquals(oldToken, token)) {\n      this.eventDispatcher.dispatch('tokenChanged', {\n        oldToken: oldToken,\n        newToken: token\n      });\n    }\n  };\n\n  Context.prototype.syncToken = function () {\n    var newToken = this.tokenStore.getToken();\n    var oldToken = this.lastToken;\n\n    if (!tokenEquals(oldToken, newToken)) {\n      this.lastToken = newToken;\n      this.eventDispatcher.dispatch('tokenChanged', {\n        oldToken: oldToken,\n        newToken: newToken\n      });\n    }\n  };\n\n  return Context;\n}();\n\nexports.Context = Context;","map":{"version":3,"names":["Object","defineProperty","exports","value","Context","token_1","require","tab_1","uuid_1","tokenEquals","left","right","toString","tab","tokenStore","eventDispatcher","lastToken","getToken","syncToken","bind","load","_a","cache","tokenScope","urlSanitizer","tabId","get","newTab","uuid4","Tab","clear","addListener","put","id","InMemoryTokenStore","context","CachedTokenStore","browserToken","primaryStorage_1","tabToken","secondaryStorage_1","isNew","setToken","event","detail","visible","ReplicatedTokenStore","prototype","getTab","isAnonymous","token","getUser","getSubject","oldToken","dispatch","newToken"],"sources":["C:/Users/User/croct/node_modules/@croct/sdk/context.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Context = void 0;\nvar token_1 = require(\"./token\");\nvar tab_1 = require(\"./tab\");\nvar uuid_1 = require(\"./uuid\");\nfunction tokenEquals(left, right) {\n    return left === right || (left !== null && right !== null && left.toString() === right.toString());\n}\nvar Context = /** @class */ (function () {\n    function Context(tab, tokenStore, eventDispatcher) {\n        this.tab = tab;\n        this.tokenStore = tokenStore;\n        this.eventDispatcher = eventDispatcher;\n        this.lastToken = tokenStore.getToken();\n        this.syncToken = this.syncToken.bind(this);\n    }\n    Context.load = function (_a) {\n        var cache = _a.cache, tokenScope = _a.tokenScope, eventDispatcher = _a.eventDispatcher, urlSanitizer = _a.urlSanitizer;\n        var tabId = cache.tabId.get();\n        var newTab = false;\n        if (tabId === null) {\n            tabId = (0, uuid_1.uuid4)(true);\n            newTab = true;\n        }\n        var tab = new tab_1.Tab(tabId, newTab, urlSanitizer);\n        cache.tabId.clear();\n        tab.addListener('unload', function () { return cache.tabId.put(tab.id); });\n        switch (tokenScope) {\n            case 'isolated':\n                return new Context(tab, new token_1.InMemoryTokenStore(), eventDispatcher);\n            case 'global': {\n                var context = new Context(tab, new token_1.CachedTokenStore(cache.browserToken), eventDispatcher);\n                cache.browserToken.addListener(context.syncToken);\n                return context;\n            }\n            case 'contextual': {\n                var primaryStorage_1 = new token_1.CachedTokenStore(cache.tabToken);\n                var secondaryStorage_1 = new token_1.CachedTokenStore(cache.browserToken);\n                if (tab.isNew) {\n                    primaryStorage_1.setToken(secondaryStorage_1.getToken());\n                }\n                tab.addListener('visibilityChange', function (event) {\n                    if (event.detail.visible) {\n                        secondaryStorage_1.setToken(primaryStorage_1.getToken());\n                    }\n                });\n                return new Context(tab, new token_1.ReplicatedTokenStore(primaryStorage_1, secondaryStorage_1), eventDispatcher);\n            }\n        }\n    };\n    Context.prototype.getTab = function () {\n        return this.tab;\n    };\n    Context.prototype.isAnonymous = function () {\n        var token = this.getToken();\n        return token == null || token.isAnonymous();\n    };\n    Context.prototype.getUser = function () {\n        var token = this.getToken();\n        return token == null ? null : token.getSubject();\n    };\n    Context.prototype.getToken = function () {\n        return this.tokenStore.getToken();\n    };\n    Context.prototype.setToken = function (token) {\n        var oldToken = this.lastToken;\n        this.lastToken = token;\n        this.tokenStore.setToken(token);\n        if (!tokenEquals(oldToken, token)) {\n            this.eventDispatcher.dispatch('tokenChanged', {\n                oldToken: oldToken,\n                newToken: token,\n            });\n        }\n    };\n    Context.prototype.syncToken = function () {\n        var newToken = this.tokenStore.getToken();\n        var oldToken = this.lastToken;\n        if (!tokenEquals(oldToken, newToken)) {\n            this.lastToken = newToken;\n            this.eventDispatcher.dispatch('tokenChanged', {\n                oldToken: oldToken,\n                newToken: newToken,\n            });\n        }\n    };\n    return Context;\n}());\nexports.Context = Context;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}